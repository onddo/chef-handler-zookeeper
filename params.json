{"name":"Chef-handler-zookeeper","tagline":"A simple Chef report handler to send notifications to Zookeeper about Chef runs.","body":"# Chef Handler Zookeeper\r\n\r\nA simple Chef report handler to send notifications to Zookeeper about Chef runs.\r\n\r\nThis Chef Handler is heavily based on [Chef Handler SNS](https://github.com/onddo/chef-handler-sns) code.\r\n\r\n* http://wiki.opscode.com/display/chef/Exception+and+Report+Handlers\r\n\r\n[![Gem Version](https://badge.fury.io/rb/chef-handler-zookeeper.png)](http://badge.fury.io/rb/chef-handler-zookeeper)\r\n[![Dependency Status](https://gemnasium.com/onddo/chef-handler-zookeeper.png)](https://gemnasium.com/onddo/chef-handler-zookeeper)\r\n[![Code Climate](https://codeclimate.com/github/onddo/chef-handler-zookeeper.png)](https://codeclimate.com/github/onddo/chef-handler-zookeeper)\r\n[![Build Status](https://travis-ci.org/onddo/chef-handler-zookeeper.png)](https://travis-ci.org/onddo/chef-handler-zookeeper)\r\n[![Coverage Status](https://coveralls.io/repos/onddo/chef-handler-zookeeper/badge.png?branch=master)](https://coveralls.io/r/onddo/chef-handler-zookeeper)\r\n\r\n## Requirements\r\n\r\n* A Zookeeper server.\r\n* Uses the `zk` Ruby gem.\r\n\r\n## Usage\r\n\r\nYou can install this handler in two ways:\r\n\r\n### Method 1: In the Chef config file\r\n\r\nYou can install the RubyGem and configure Chef to use it:\r\n\r\n    gem install chef-handler-zookeeper\r\n\r\nThen add to the configuration (`/etc/chef/solo.rb` for chef-solo or `/etc/chef/client.rb` for chef-client):\r\n\r\n```ruby\r\nrequire \"chef/handler/zookeeper\"\r\n\r\n# Create the handler\r\nzookeeper_handler = Chef::Handler::ZookeeperHandler.new\r\n\r\n# Some Zookeeper configurations\r\nzookeeper_handler.server \"zookeeper.mydomain.com\"\r\nzookeeper_handler.znode \"/chef/#{`hostname`.chomp}/chef_status\"\r\n\r\n# Add your handler\r\nstart_handlers << zookeeper_handler\r\nexception_handlers << zookeeper_handler\r\nreport_handlers << zookeeper_handler\r\n```\r\n\r\n### Method 2: In a recipe with the chef_handler LWRP\r\n\r\nUse the [chef_handler LWRP](http://community.opscode.com/cookbooks/chef_handler), creating a recipe with the following:\r\n\r\n```ruby\r\n# A compiler is required for the `zk` gem\r\nnode.default['build_essential']['compiletime'] = true\r\ninclude_recipe 'build-essential'\r\n\r\n# Handler configuration options\r\nargument_array = [\r\n  :server => \"zookeeper.mydomain.com:2181\",\r\n  :znode => \"/chef/somepath/chef_status\",\r\n]\r\n\r\n# Install the `chef-handler-zookeeper` RubyGem during the compile phase\r\nchef_gem \"chef-handler-zookeeper\"\r\n\r\n# Then activate the handler with the `chef_handler` LWRP\r\nchef_handler \"Chef::Handler::ZookeeperHandler\" do\r\n  source \"#{Gem::Specification.find_by_name(\"chef-handler-zookeeper\").lib_dirs_glob}/chef/handler/zookeeper\"\r\n  arguments argument_array\r\n  supports :report => true, :exception => true\r\n  action :enable\r\nend\r\n```\r\n\r\nIf you have an old version of gem package (< 1.8.6) without `find_by_name` or old chef-client (< 0.10.10) without `chef_gem`, you can try creating a recipe similar to the following:\r\n\r\n```ruby\r\n# A compiler is required for the `zk` gem\r\nnode.default['build_essential']['compiletime'] = true\r\ninclude_recipe 'build-essential'\r\n\r\n# Handler configuration options\r\nargument_array = [\r\n  :server => \"zookeeper.mydomain.com:2181\",\r\n  :znode => \"/chef/somepath/chef_status\",\r\n]\r\n\r\n# Install the `chef-handler-zookeeper` RubyGem during the compile phase\r\nif defined?(Chef::Resource::ChefGem)\r\n  chef_gem \"chef-handler-zookeeper\"\r\nelse\r\n  gem_package(\"chef-handler-zookeeper\") do\r\n    action :nothing\r\n  end.run_action(:install)\r\nend\r\n\r\n# Get the installed `chef-handler-zookeeper` gem path\r\nzookeeper_handler_path = Gem::Specification.respond_to?(\"find_by_name\") ?\r\n  Gem::Specification.find_by_name(\"chef-handler-zookeeper\").lib_dirs_glob :\r\n  Gem.all_load_paths.grep(/chef-handler-zookeeper/).first\r\n\r\n# Then activate the handler with the `chef_handler` LWRP\r\nchef_handler \"Chef::Handler::ZookeeperHandler\" do\r\n  source \"#{zookeeper_handler_path}/chef/handler/zookeeper\"\r\n  arguments argument_array\r\n  supports :report => true, :exception => true\r\n  action :enable\r\nend\r\n```\r\n\r\n#### start_handler\r\n\r\nIf you want to run also as a *start handler* using `chef_handler` cookbook, you can use a recipe similar to the following:\r\n\r\n```ruby\r\n# [...]\r\n\r\n# We will need to install the chef handler at compile time\r\nchef_handler \"Chef::Handler::ZookeeperHandler\" do\r\n# [...]\r\n  action :nothing\r\nend.run_action(:enable)\r\n\r\n# based on code from chef-sensu-handler cookbook: https://github.com/needle-cookbooks/chef-sensu-handler/blob/master/recipes/default.rb\r\nruby_block 'trigger_start_handlers' do\r\n  block do\r\n    require 'chef/run_status'\r\n    require 'chef/handler'\r\n\r\n    # a bit tricky, required by the default start.json.erb template to have access to node\r\n    Chef::Handler.run_start_handlers(self)\r\n  end\r\n  action :nothing\r\nend.run_action(:create)\r\n```\r\n\r\n## Handler Configuration Options\r\n\r\nThe following options are available to configure the handler:\r\n\r\n* `server` - The Zookeeper server hostname and port (required).\r\n* `znode` - Path of the znode to write to (required). **The znode must already exist**.\r\n* `start_template` - Full path of an erubis template file to use for the znode body on Chef run start (optional).\r\n* `end_template` - Full path of an erubis template file to use for the znode body when Chef run ended (optional).\r\n\r\n### start_template and end_template\r\n\r\nThis configuration options need to contain the full path of an erubis template. For example:\r\n\r\n```ruby\r\n# recipe \"myapp::zookeeper_handler\"\r\n\r\ncookbook_file \"chef_handler_zookeeper_body.erb\" do\r\n  path \"/tmp/chef_handler_zookeeper_body.erb\"\r\n  # [...]\r\nend\r\n\r\nargument_array = [\r\n  :server => \"zookeeper.mydomain.com:2181\",\r\n  :znode => \"/chef/somepath/chef_status\",\r\n  :end_template => \"/tmp/chef_handler_zookeeper_body.erb\",\r\n]\r\nchef_handler \"Chef::Handler::ZookeeperHandler\" do\r\n  # [...]\r\n  arguments argument_array\r\nend\r\n```\r\n\r\n```erb\r\n<%# file \"myapp/files/default/chef_handler_zookeeper_body.erb\" %>\r\n\r\nNode Name: <%= node.name %>\r\n<% if node.attribute?(\"fqdn\") -%>\r\nHostname: <%= node.fqdn %>\r\n<% end -%>\r\n\r\nChef Run List: <%= node.run_list.to_s %>\r\nChef Environment: <%= node.chef_environment %>\r\n\r\n<% if node.attribute?(\"ec2\") -%>\r\nInstance Id: <%= node.ec2.instance_id %>\r\nInstance Public Hostname: <%= node.ec2.public_hostname %>\r\nInstance Hostname: <%= node.ec2.hostname %>\r\nInstance Public IPv4: <%= node.ec2.public_ipv4 %>\r\nInstance Local IPv4: <%= node.ec2.local_ipv4 %>\r\n<% end -%>\r\n\r\nChef Client Elapsed Time: <%= elapsed_time.to_s %>\r\nChef Client Start Time: <%= start_time.to_s %>\r\nChef Client Start Time: <%= end_time.to_s %>\r\n\r\n<% if exception -%>\r\nException: <%= run_status.formatted_exception %>\r\nStacktrace:\r\n<%= Array(backtrace).join(\"\\n\") %>\r\n\r\n<% end -%>\r\n```\r\n\r\nThe following variables are accessible inside the template:\r\n\r\n* `start_time` - The time the chef run started.\r\n* `end_time` - The time the chef run ended.\r\n* `elapsed_time` - The time elapsed between the start and finish of the chef run.\r\n* `run_context` - The Chef::RunContext object used by the chef run.\r\n* `exception` - The uncaught Exception that terminated the chef run, or nil if the run completed successfully.\r\n* `backtrace` - The backtrace captured by the uncaught exception that terminated the chef run, or nil if the run completed successfully.\r\n* `node` - The Chef::Node for this client run.\r\n* `all_resources` - An Array containing all resources in the chef run's resource_collection.\r\n* `updated_resources` - An Array containing all resources that were updated during the chef run.\r\n* `success?` - Was the chef run successful? True if the chef run did not raise an uncaught exception.\r\n* `failed?` - Did the chef run fail? True if the chef run raised an uncaught exception.\r\n\r\nDefault templates are in the [templates](https://github.com/onddo/chef-handler-zookeeper/tree/master/lib/chef/handler/zookeeper/templates) directory.\r\n\r\n**Note:** When using `start_template` with the **chef_handler cookbook**, only the `node` variable will be accesible from the template.\r\n\r\n## Running the tests\r\n\r\nMinitest tests can be run as usual:\r\n\r\n    rake test\r\n\r\n# TODO\r\n\r\n* Support for znode creation:\r\n  * Including *:create* boolean, *:acl* for the ACL and *:recursive*.\r\n* Add digest authentication support.\r\n\r\n## Contributing\r\n\r\n[Pull Requests](http://github.com/onddo/chef-handler-zookeeper/pulls) are welcome.\r\n\r\n## License and Author\r\n\r\n|                      |                                          |\r\n|:---------------------|:-----------------------------------------|\r\n| **Author:**          | Xabier de Zuazo (<xabier@onddo.com>)\r\n| **Copyright:**       | Copyright (c) 2013 Onddo Labs, SL. (www.onddo.com)\r\n| **License:**         | Apache License, Version 2.0\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}